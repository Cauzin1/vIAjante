import google.generativeai as genai
from dotenv import load_dotenv
import os
import re
import time
from flask import Flask, request, jsonify
from flask_cors import CORS
from utils.pdf_generator import gerar_pdf

load_dotenv()

try:
    genai.configure(api_key=os.getenv("GEMINI_KEY"))
    model = genai.GenerativeModel('gemini-1.5-flash')
    print("‚úÖ Gemini configurado com sucesso!")
except Exception as e:
    print(f"‚ùå Erro na configura√ß√£o do Gemini: {str(e)}")
    exit(1)

app = Flask(__name__)
CORS(app)

sessoes = {}

PAISES_EUROPA = [
    "alemanha", "albania", "andorra", "armenia", "austria", "azerbaijao",
    "belgica", "bielorrussia", "bosnia", "bulgaria",
    "chipre", "croacia", "dinamarca",
    "eslovaquia", "eslovenia", "espanha", "estonia",
    "finlandia", "franca",
    "georgia", "grecia", "holanda", "hungria",
    "irlanda", "islandia", "italia",
    "letonia", "liechtenstein", "lituania", "luxemburgo",
    "macedonia", "malta", "moldavia", "monaco", "montenegro",
    "noruega",
    "polonia", "portugal",
    "reino unido", "romenia", "russia",
    "san marino", "servia", "suecia", "suica",
    "turquia", "ucrania", "vaticano"
]

# Dicas contextuais para cada etapa
DICAS = {
    "DESTINO": "\nüí° Dica: Pa√≠ses como It√°lia e Fran√ßa s√£o √≥timos para primeira viagem!",
    "DATAS": "\nüí° Dica: Evite alta temporada (julho/agosto) para economizar!",
    "ORCAMENTO": "\nüí° Dica: Lembre-se de incluir 20% extra para imprevistos!",
    "GERANDO_ROTEIRO": "\n‚è±Ô∏è Isso pode levar alguns segundos enquanto preparo tudo com carinho..."
}

# Palavras de agradecimento
AGRADECIMENTOS = ["obrigado", "obrigada", "valeu", "agrade√ßo", "thanks", "grato", "obgd"]

def validar_destino(texto: str) -> bool:
    texto_limpo = texto.lower().strip()
    return any(pais in texto_limpo for pais in PAISES_EUROPA)

def validar_data(texto: str) -> bool:
    pattern = r"\d{2}/\d{2}\s*a\s*\d{2}/\d{2}"
    return re.match(pattern, texto) is not None

def validar_orcamento(texto: str) -> bool:
    texto = texto.lower().strip().replace("r$", "").replace(" ", "")
    texto = texto.replace(".", "").replace(",", ".")
    if "mil" in texto:
        texto = texto.replace("mil", "")
        try:
            valor = float(texto) * 1000
            return valor > 0
        except ValueError:
            return False
    try:
        valor = float(texto)
        return valor > 0
    except ValueError:
        return False

def formatar_resposta_gemini(texto: str) -> str:
    texto = texto.replace("**", "*")
    texto = texto.replace("\u2022", " -")
    texto = re.sub(r'\n{3,}', '\n\n', texto)
    if len(texto) > 3000:
        texto = texto[:3000] + "\n[...] (continua no roteiro completo)"
    return texto

@app.route('/chat', methods=['POST'])
def chat_endpoint():
    data = request.json
    session_id = data.get('session_id')
    message = data.get('message', '').strip()
    if session_id not in sessoes:
        sessoes[session_id] = {
            'estado': 'SAUDACAO',
            'dados': {}
        }
    resposta = processar_mensagem(session_id, message)
    return jsonify({'response': resposta})

def processar_mensagem(session_id: str, texto: str) -> str:
    estado = sessoes[session_id]['estado']
    dados_usuario = sessoes[session_id]['dados']
    texto = texto.strip().lower()

    # Reconhecer agradecimentos
    if any(palavra in texto for palavra in AGRADECIMENTOS):
        return "üòä De nada! Estou aqui para ajudar. O que mais posso fazer por voc√™?"
    
    # Reconhecer sauda√ß√µes
    if texto in ["oi", "ola", "ol√°", "bom dia", "boa tarde", "boa noite"] and estado != "SAUDACAO":
        return f"Ol√°! üòä Como posso te ajudar com sua viagem para *{dados_usuario.get('destino', 'a Europa')}*?"

    if texto == "reiniciar":
        sessoes[session_id] = {'estado': 'SAUDACAO', 'dados': {}}
        return "üîÑ Certo! Vamos come√ßar uma nova viagem. Para onde na Europa voc√™ quer viajar?"

    if estado == "SAUDACAO":
        sessoes[session_id]['estado'] = "DESTINO"
        return (f"üåü Ol√°! ‚úàÔ∏è Eu sou o vIAjante, seu especialista em viagens pela Europa. "
                f"Estou aqui para criar a viagem dos seus sonhos!\n\n"
                f"Pra come√ßar, me conta: pra qual *pa√≠s* voc√™ quer viajar? "
                f"(It√°lia, Fran√ßa, Espanha, Portugal...)\n\n"
                f"üí° Se precisar recome√ßar a qualquer momento, √© s√≥ dizer 'reiniciar'")

    elif estado == "DESTINO":
        if not validar_destino(texto):
            return ("‚ùå *Pa√≠s n√£o reconhecido* üòü\n"
                    "Por favor, informe um *pa√≠s europeu v√°lido*. Alguns exemplos:\n"
                    "```\n"
                    "- It√°lia\n"
                    "- Fran√ßa\n"
                    "- Espanha\n"
                    "- Portugal\n"
                    "- Alemanha\n"
                    "```\n"
                    "‚ÑπÔ∏è No momento atendemos apenas pa√≠ses da Europa.")
        
        pais_formatado = texto.title()
        dados_usuario["destino"] = pais_formatado
        sessoes[session_id]['estado'] = "DATAS"
        
        resposta = (f"‚úàÔ∏è *{pais_formatado} √© uma √≥tima escolha!* J√° visitei v√°rias vezes üó∫Ô∏è\n"
                    f"Agora me conta: *quando* voc√™ vai viajar?\n\n"
                    f"üìÖ Por favor, informe as datas no formato:\n`DD/MM a DD/MM`\n"
                    f"Exemplo: `15/08 a 30/08`")
        
        # Adicionar dica contextual
        resposta += DICAS.get(estado, "")
        return resposta

    elif estado == "DATAS":
        if texto == "voltar":
            sessoes[session_id]['estado'] = "DESTINO"
            return "üîô Voltando √† escolha do pa√≠s... Qual pa√≠s voc√™ escolheu?"
        
        if not validar_data(texto):
            return ("‚ùå *Formato incorreto* ‚ö†Ô∏è\n"
                    "Por favor, use o formato: `DD/MM a DD/MM`\n\n"
                    "Exemplo: `15/08 a 30/08`\n\n"
                    "Ou digite `voltar` para escolher outro pa√≠s.")
        
        dados_usuario["datas"] = texto
        sessoes[session_id]['estado'] = "ORCAMENTO"
        
        resposta = ("üí∞ *Quase l√°!* Agora me fale sobre o or√ßamento da viagem:\n\n"
                    "üíµ Por favor, informe o valor total em Reais (R$):\n"
                    "```\n"
                    "Exemplos:\n"
                    "15000\n"
                    "R$ 15.000\n"
                    "20 mil\n"
                    "```")
        
        # Adicionar dica contextual
        resposta += DICAS.get(estado, "")
        return resposta

    elif estado == "ORCAMENTO":
        if texto == "voltar":
            sessoes[session_id]['estado'] = "DATAS"
            return "üîô Voltando √†s datas... Qual o per√≠odo da viagem?"
        
        if not validar_orcamento(texto):
            return ("‚ùå *Valor inv√°lido* ‚ö†Ô∏è\n"
                    "Por favor, informe um valor num√©rico v√°lido:\n"
                    "```\n"
                    "Exemplos:\n"
                    "15000\n"
                    "R$ 15.000\n"
                    "20 mil\n"
                    "```\n\n"
                    "Ou digite `voltar` para ajustar as datas.")
        
        # Extrai e formata o valor
        valor_str = texto.lower().strip().replace("r$", "").replace(" ", "")
        valor_str = valor_str.replace(".", "").replace(",", ".")
        if "mil" in valor_str:
            valor_str = valor_str.replace("mil", "")
            valor = float(valor_str) * 1000
        else:
            valor = float(valor_str)
            
        # Formata√ß√£o bonita para exibi√ß√£o
        valor_formatado = f"R${valor:,.2f}"
        valor_formatado = valor_formatado.replace(",", "X").replace(".", ",").replace("X", ".")
        dados_usuario["orcamento"] = valor_formatado

        # Pequeno delay para simular processamento
        time.sleep(1)
        
        sessoes[session_id]['estado'] = "GERANDO_ROTEIRO"
        resposta = (f"‚è±Ô∏è *Perfeito! Estou preparando seu roteiro personalizado para {dados_usuario['destino']}...*\n\n"
                    f"üîπ Consultando melhores atra√ß√µes\n"
                    f"üîπ Analisando op√ß√µes de hospedagem\n"
                    f"üîπ Calculando rotas ideais\n\n"
                    f"Fique tranquilo(a), em instantes seu planejamento completo estar√° pronto! ‚ú®")
        
        # Adicionar dica contextual
        resposta += DICAS.get(estado, "")
        return resposta

    elif estado == "GERANDO_ROTEIRO":
        try:
            # Simular "digita√ß√£o" humana
            time.sleep(2)
            
            prompt = f"""
            Voc√™ √© um especialista em viagens para Europa chamado Rog√©rio. Crie um roteiro detalhado com base nestas informa√ß√µes:
            - Destino: {dados_usuario['destino']}
            - Per√≠odo: {dados_usuario['datas']}
            - Or√ßamento total: {dados_usuario['orcamento']}
            
            Inclua:
            1. Itiner√°rio di√°rio com atra√ß√µes principais (use emojis)
            2. Sugest√µes de transporte entre cidades (com dicas locais)
            3. Op√ß√µes de hospedagem em 3 categorias (econ√¥mica, m√©dia, luxo)
            4. Dicas pessoais de quem conhece bem o destino
            5. Estimativa de custos por categoria
            
            Formate de forma amig√°vel e pessoal, como se estivesse conversando com um amigo.
            Assine como "Rog√©rio - Seu Especialista em Viagens"
            """
            response = model.generate_content(prompt)
            resposta_formatada = formatar_resposta_gemini(response.text)
            dados_usuario['roteiro'] = resposta_formatada
            sessoes[session_id]['estado'] = "ROTEIRO_GERADO"
            
            # Pequeno delay final
            time.sleep(0.5)
            
            return (f"üéâ *Prontinho! Acabei de finalizar seu roteiro para {dados_usuario['destino']}!*\n\n"
                    f"Espero que goste das minhas sugest√µes - selecionei lugares incr√≠veis pensando em voc√™:\n\n"
                    f"{resposta_formatada}\n\n"
                    f"üìå *O que gostaria de fazer agora?*\n"
                    f"- Digite `pdf` para receber este roteiro em PDF\n"
                    f"- Digite `ajuda` para outras op√ß√µes\n"
                    f"- Digite `reiniciar` para criar uma nova viagem")
        except Exception as e:
            sessoes[session_id]['estado'] = "SAUDACAO"
            return (f"‚ùå *Opa! Algo deu errado aqui.* üòü\n"
                    f"Erro: {str(e)}\n\n"
                    f"Vamos recome√ßar? Digite `iniciar`.")

    elif estado == "ROTEIRO_GERADO":
        if texto == "ajuda":
            return (f"‚ÑπÔ∏è *Como posso te ajudar com seu roteiro para {dados_usuario['destino']}?*\n\n"
                    f"‚úàÔ∏è `destino` - Alterar o pa√≠s de destino\n"
                    f"üìÖ `datas` - Alterar as datas da viagem\n"
                    f"üíµ `or√ßamento` - Ajustar o valor do or√ßamento\n"
                    f"üìÑ `pdf` - Receber seu roteiro completo em PDF\n"
                    f"üîÑ `reiniciar` - Come√ßar um novo planejamento\n\n"
                    f"√â s√≥ me dizer o que precisa! üòä")
        
        elif texto == "destino":
            sessoes[session_id]['estado'] = "DESTINO"
            return "üîô Vamos alterar o destino. Para qual pa√≠s voc√™ quer viajar?"
        
        elif texto == "datas":
            sessoes[session_id]['estado'] = "DATAS"
            return f"üîô Vamos alterar as datas. Qual o novo per√≠odo para *{dados_usuario['destino']}*?"
        
        elif texto == "or√ßamento":
            sessoes[session_id]['estado'] = "ORCAMENTO"
            return "üîô Vamos alterar o or√ßamento. Qual o novo valor?"
        
        elif texto == "pdf":
            try:
                caminho_pdf = gerar_pdf(
                    destino=dados_usuario['destino'],
                    datas=dados_usuario['datas'],
                    orcamento=dados_usuario['orcamento'],
                    roteiro_texto=dados_usuario['roteiro'],
                    session_id=session_id
                )
                return (f"üìÑ *Seu PDF est√° pronto!* ‚úÖ\n"
                        f"Voc√™ pode acess√°-lo aqui: `{caminho_pdf}`\n\n"
                        f"Precisa de mais alguma coisa? Digite `ajuda` para ver op√ß√µes.")
            except Exception as e:
                return (f"‚ùå *Opa, tive um problema ao gerar o PDF* üòü\n"
                        f"Erro: {str(e)}\n\n"
                        f"Posso tentar novamente ou te ajudar com outra coisa?")
        
        elif texto == "reiniciar":
            sessoes[session_id] = {'estado': 'SAUDACAO', 'dados': {}}
            return "üîÑ Beleza! Vamos come√ßar uma nova aventura. Para onde na Europa voc√™ quer viajar?"
        
        else:
            return (f"ü§î *N√£o entendi bem...*\n"
                    f"Voc√™ j√° tem um roteiro para {dados_usuario['destino']} pronto!\n\n"
                    f"Digite `ajuda` para ver o que posso fazer por voc√™.")

    return "‚ùå *Ops! Algo deu errado.* üòü\nPor favor, digite `reiniciar` para come√ßar de novo."

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=3000, debug=True)